---
title: "Quant_Reg_Results_Plots"
output: html_document
date: "2025-05-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Packages
-----------
```{r}
library(tidyverse)
library(paletteer)
library(data.table)
library(ggdist)
library(ggrepel)
library(missMDA)
library(FactoMineR)
library(factoextra)
library(patchwork)
library(ggpubr)
library(scales)
```



```{r}
#New Classifications
#Trace elements
Trace_Elements_Theme <- unique(c("As","Ba", "Be","Cd" ,"Co","Cs","Mn", 
                  "Mo","Pb","Sb", "Tl","U", "W","Cr","Cu",
                  "Hg" ,"Ni","Pt","Sn",
                  "V","Zn", "Al", "Mg","Se"  ))


length(Trace_Elements_Theme)
#Phenols
Phenols_Theme <- unique(c("BP3","BPA","BPF","BPS","DCP24","DCP25","TCC","TCS","BUPB","ETPB","MEPB","PRPB","BP1",
                          "BP2","BP8","BPAF","BPAP","BPB","BPP","BPZ","DHB34","HB4",
                          "OH4BP","OHETP","OHMEP","PCP","TCP245","TCP246","DCP","TCP24","PHE","PHEN"))
length(Phenols_Theme)

#Polycyclic_Aromatic_hydrocarbons 
PAH_Theme <- unique(c("NAP1","NAP2","PYR1","FLUO2","PHEN1","PHEN2PHEN3","PHEN4","PHEN9","PHET","PHEN2",
                      "PHEN3","FLUO2_FLUO3","PHEN2_PHEN3","FLU","FLUO","PYR","NAP"))

length(PAH_Theme)

#Phthalates
Phthalates_Theme <- unique(c("MBZP","MCPP","MECPP","MEHHP","MEHP","MEOHP","MEP","MIBP","MNBP","MCMHP",
                             "MCHP","MCHPP","MCINP","MCIOP","MCMHP","MHXP","MINP","MIPP","MMP","MOP","MPEP",
                             "MCOCH","MHNCH","MINP","MCOP","MECPTP","MBZP","MCPP","MEHHTP","MIBP","MHPP","MBZ","MBP",
                             "MCI","MCMH","MCO","MCP","MEC","MEH","MEHH","MEO","MEOH","MHN","MIB","MIN",
                             "MNB"))

length(Phthalates_Theme)

#Parabens
Parabens_Theme <- unique(c("BUPB","ETPB","MEPB","PRPB","BZPB","HEPB","BUP","ETP","PRP"))
length(Parabens_Theme)

#Smoking/Smoking
Smoking_Theme <- unique(c("COTT","HCOTT","NICT","NNAL","COT"))
length(Smoking_Theme)

#Inflam
Inflam_Theme <- unique(c("HAPTOGLOBIN","FLT3L","TIMP1","TIMP2","IL17F","GMCSF","IFNG","IL10","MIP3A",
                         "IL12P70", "IL13","IL15","IL17A","IL22","IL9","IL1B","IL33","IL2","IL21",
                         "IL4"," IL23","IL5","IL6","IL17EIL25","IL27","IL31","TNFA","TNFB","IL28A",
                         "MMP1","MMP2","MMP7","MMP9","MMP10","CRP","LTE4","IL8","IL23"))

length(Inflam_Theme)

#Pesticide

Pesticide_Theme <- unique(c("DEP","DETP","DMDP","DMP","DMTP","PBA",
                            "TCP","DEDP","GPS","FPBA","PNP","IMPY","D24","AMPA",
                            "MDA","T245","BHCH","HCB","PPDDE","PPDDT","TCHL","TNON",
                            "OCHL","PPDDD"))

length(Pesticide_Theme)

#Volatile Organic Compounds
VOC_Theme <- unique(c("HPMA","HPMA2","SPMA","HMPMA"))

length(VOC_Theme)

#Oxidative Stress Markers
OXID_Theme <- unique(c("F2A8IP","F2A23D","F2AVI","F2A12I","OS8OHDG","OSMDA","OS8O","OSMD"))

length(OXID_Theme)

#PFAS
PFAS_Theme <- unique(c("NMFOSAA","PFBS" ,"PFDA","PFDODA" ,
                "PFDS" ,"PFHPA" ,"PFHXA" , "PFHXS" ,
                "PFNA" , "PFOA" , "PFOS","PFOSA", "PFUNDA",
                "NETFOSAA","PFPEA","ETFOSA","PFBA","PFPEA","PFHPS"))

length(PFAS_Theme)

#Flame Retardants
Flame_Retardant_Theme <- unique(c("BDE47","BDE99","BDE100","BDCPP","DPHP","TBBA",
                                  "BCETP","BCPP","DBUP","DBZP","DOCP","DPCP","BDE153",
                                  "BDE154","BDE183","BDE28","BDE47","BDE17","BDE66",
                                  "BDE85","BDE99","PBB153","BDE28","BDE85"))
length(Flame_Retardant_Theme)

PCB_Theme <- unique(c( "PCB105_PCB127","PCB110", "PCB114_PCB122","PCB118_PCB106", "PCB128", "PCB137",
  "PCB138_PCB158","PCB146_PCB161", "PCB153","PCB156","PCB157","PCB167","PCB170","PCB172_PCB192", "PCB177",
  "PCB180","PCB182_PCB187","PCB183", "PCB18_PCB17","PCB194",
  "PCB195","PCB196_PCB203", "PCB199","PCB202","PCB206","PCB208","PCB209","PCB22",
  "PCB31_PCB28", "PCB33_PCB20","PCB37","PCB41_PCB64","PCB44","PCB47_48_75",
  "PCB49_PCB43","PCB52_PCB73","PCB5_PCB8","PCB70_PCB76","PCB73_PCB95","PCB74_PCB61",
  "PCB85_PCB120","PCB90_101_89","PCB99"))

#Bisdithiocarbamates 
Bisdithiocarbamates_Theme <- unique(c("ETU","PTU"))

#Cellular adhesion molecules 
CAM_Theme <- unique(c("ICAM1","VCAM1","ESEL","PSEL"))

#Lipids

Lipids_Theme <- unique(c("CHOL","OXLDL","TG"))

#Nutrients
Nutrients_Theme <- unique(c("GAMTOC","ALPTOC","ZEAXAN","CRYPTO","LYCOPE","ALPCARO",
                            "BETCARO","RET","FOL","ADIPO"))
length(Nutrients_Theme)


Lipid_Metab <- c("LEP")

Thromboxane <- c("DHTHRM")


Other_Theme <- c(Bisdithiocarbamates_Theme,CAM_Theme,Lipids_Theme,Nutrients_Theme,Lipid_Metab,Thromboxane)
```
Input Data
------------

```{r}


load("../../../Input/Harmonized_Datasets/DCHS_SDOH_Clean.RData")
load("../../../Input/Harmonized_Datasets/ELEMENT_SDOH_Clean.RData")

load("../../../Input/Harmonized_Datasets/Harmonized_Targeted.RData")


```

```{r}
std_study <- function(x) {
  stringr::str_remove(x, '[_]\\w+|:')  # CHECK: ensure this collapse is intended
}
to_ng_per_mL <- function(value, units) {
  dplyr::case_when(
    is.na(units)          ~ value,          # assume already ng/mL if missing
    units == "ng/mL"      ~ value,
    units == "ug/dL"      ~ value * 10,     # 1 ug/dL = 10 ng/mL
    units %in% c("ng/L")  ~ value / 1000,   # 1 ng/L = 0.001 ng/mL
    units %in% c("pg/mL","pg/ml") ~ value / 1000,  # 1000 pg/mL = 1 ng/mL
    units == "mg/L"       ~ value * 1000,   # 1 mg/L = 1000 ng/mL
    TRUE ~ value          # CHECK: any other units present?
  )
}
Child_Data_Targeted <- Targeted_Data_All %>%
  filter(!is.na(Child_PID)) %>%                           # keep child samples
  mutate(
    Units = if_else(is.na(Units), "ng/mL", Units),        # default units
    Concentration = to_ng_per_mL(Concentration, Units)    # normalize units
  ) %>%
  select(-Mat_PID) %>%                                    # not needed for child
  filter(!is.na(Analyte_Code)) %>%                        # require analyte code
  group_by(Study, Child_PID, Analyte_Code) %>%            # average replicates
  summarise(Concentration = mean(Concentration, na.rm = TRUE), .groups = "drop")

child_analytes <- sort(unique(Child_Data_Targeted$Analyte_Code))  # vector of analytes

# Build a list of per-analyte wide data.frames keyed by Child_PID ---------
child_list_Targeted <- purrr::map(
  child_analytes,
  ~ Child_Data_Targeted %>%
    filter(Analyte_Code == .x) %>%                         # one analyte
    mutate(Study = std_study(Study)) %>%                   # standardize label
    select(Study, Child_PID, Analyte_Code, Concentration) %>%
    tidyr::pivot_wider(names_from = Analyte_Code, values_from = Concentration) %>%
    select(Child_PID, Study, all_of(.x))                   # only current analyte col
) %>%
  rlang::set_names(child_analytes)

# MATERNAL targeted data: long -> wide per-analyte list -------------------
Mat_Data_Targeted <- Targeted_Data_All %>%
  filter(!is.na(Mat_PID)) %>%                              # keep maternal samples
  select(-Child_PID) %>%
  mutate(
    Units = if_else(is.na(Units), "ng/mL", Units),
    Concentration = to_ng_per_mL(Concentration, Units)
  ) %>%
  filter(!is.na(Analyte_Code)) %>%
  group_by(Study, Mat_PID, Analyte_Code) %>%
  summarise(Concentration = mean(Concentration, na.rm = TRUE), .groups = "drop") %>%
  mutate(across(everything(), ~ replace(., is.infinite(.), NA_real_)))  

mat_analytes <- sort(unique(Mat_Data_Targeted$Analyte_Code))

mat_list_Targeted <- purrr::map(
  mat_analytes,
  ~ Mat_Data_Targeted %>%
    filter(Analyte_Code == .x) %>%
    mutate(Study = std_study(Study)) %>%
    select(Study, Mat_PID, Analyte_Code, Concentration) %>%
    tidyr::pivot_wider(names_from = Analyte_Code, values_from = Concentration) %>%
    select(Mat_PID, Study, all_of(.x))
) %>%
  rlang::set_names(mat_analytes)



Child_Sample_Yr <- Targeted_Data_All %>%
  filter(!is.na(Child_PID)) %>% 
  select(-Mat_PID) %>%                                   
  group_by(Child_PID,Sample_Collection_Year) %>% 
  summarise(n = n()) 

Mat_Sample_Yr <- Targeted_Data_All %>% 
  filter(!is.na(Mat_PID)) %>% 
  select(-Child_PID) %>%                                   
  group_by(Mat_PID,Sample_Collection_Year) %>% 
  summarise(n = n())
# Split SDOH into child and maternal panels -------------------------------

```

```{r}

studies <- paste0(c("DCHS","ELEMENT"),collapse = "|")

Mapping <- bind_rows(DCHS_SDOH %>% dplyr::select(Mat_PID,Child_PID) %>% mutate(Study = "DCHS_Targeted"),
                     ELEMENT_SDOH %>% dplyr::select(Mat_PID,Child_PID) %>% mutate(Study = "ELEMENT_Targeted"))


Child_Data <- Child_Data_Targeted %>% 
  filter(str_detect(Study, studies)) %>% 
  rename(Concentration_Child = Concentration)

Mat_Data <- Mat_Data_Targeted %>% 
  filter(str_detect(Study, studies)) %>% 
  rename(Concentration_Mat = Concentration) 

child_analytes <- unique(Child_Data$Analyte_Code)
mat_analytes <- unique(Mat_Data$Analyte_Code)

All_Data <- Mat_Data_Targeted %>% 
  filter(str_detect(Study, studies)) %>% 
  rename(Concentration_Mat = Concentration) %>% 
  left_join(.,Mapping,by = c("Mat_PID","Study")) %>% 
  left_join(.,Child_Data, by = c("Child_PID","Study","Analyte_Code")) %>% 
  mutate(Conc_Diff = abs(Concentration_Mat - Concentration_Child)) %>% 
  left_join(.,Mat_Sample_Yr, by = "Mat_PID")

params <- All_Data %>%
  #dplyr::filter(Study == "DCHS_Targeted") %>% 
  summarise(
    global_mean = mean(c(Concentration_Mat, Concentration_Child), na.rm = TRUE),
    global_sd   = sd(c(Concentration_Mat, Concentration_Child), na.rm = TRUE)
  )



plot_data <- All_Data %>% 
  #dplyr::filter(Study == "DCHS_Targeted") %>% 
  bind_cols(params) %>% 
  mutate(
    log_ratio = log1p(Concentration_Child) - log1p(Concentration_Mat)
  ) %>% 
  mutate( highlight = case_when(
      log_ratio >= quantile(log_ratio, 0.90,na.rm = T) ~ "High",
      log_ratio <= quantile(log_ratio, 0.10,na.rm = T) ~ "Low",
      TRUE                                   ~ "Normal"
    )
) %>% 
    mutate(Category = case_when(
    Analyte_Code %in% Trace_Elements_Theme ~ "TraceElements",
    Analyte_Code %in% Phenols_Theme ~ "Phenols",
    Analyte_Code %in% Phthalates_Theme ~ "Phthalates",
    Analyte_Code %in% PAH_Theme ~ "PAH",
    Analyte_Code %in% PCB_Theme ~ "PCB",
    Analyte_Code %in% Parabens_Theme ~ "Parabens",
    Analyte_Code %in% Smoking_Theme ~ "Smoking",
    Analyte_Code %in% Inflam_Theme ~ NA,
    Analyte_Code %in% Pesticide_Theme ~ "Pesticides",
    Analyte_Code %in% VOC_Theme ~ "VOCs",
    Analyte_Code %in% OXID_Theme ~ NA,
    Analyte_Code %in% Flame_Retardant_Theme ~ "FlameRetardants",
    Analyte_Code %in% Other_Theme ~ NA,
    Analyte_Code %in% PFAS_Theme ~ "PFAS"
  )) %>%
  dplyr::filter(!is.na(Category))


  



```

```{r}
# ggplot(plot_data, aes(x = log_ratio)) +
#   geom_density(fill = "steelblue", alpha = 0.5) +
#   geom_vline(xintercept = 0, linetype = "dashed") +
#   labs(
#     x = "log(Child) - log(Adult)",
#     title = "Distribution of Child–Adult Log Ratios"
#   ) +
#   theme_classic()

```




```{r}

df2 <- plot_data %>%
  group_by(Analyte_Code) %>%
  summarise(
    mean_log_ratio = mean(log_ratio, na.rm = TRUE)
  )




plot_data_vi <- plot_data %>%
  left_join(df2, by = "Analyte_Code") %>%
  mutate(
    Analyte_Code = reorder(Analyte_Code, mean_log_ratio)
  )

spread_tbl <- plot_data_vi %>%
  group_by(Analyte_Code) %>%
  summarise(
    spread_IQR = IQR(log_ratio, na.rm = TRUE)
  )

# plot_data_vi2 <- plot_data_vi %>%
#   group_by(Analyte_Code) %>%
#   mutate(med_log = median(log_ratio, na.rm = TRUE)) %>%
#   ungroup() %>%
#   mutate(
#     # order from low → high median log-ratio
#     Analyte_Code = fct_reorder(Analyte_Code, med_log)
#   )

# 2. Join back and reorder analytes by spread (largest → smallest)
plot_data_vi2 <- plot_data_vi %>%
  left_join(spread_tbl, by = "Analyte_Code") %>%
  mutate(
    Analyte_Code = fct_reorder(Analyte_Code, spread_IQR, .desc = F)
  )

plot_data_vi %>%
  group_by(Analyte_Code) %>%
  summarise(
    n = n(),
    sd_log = sd(log_ratio, na.rm = TRUE),
    n_unique = n_distinct(log_ratio)
  ) %>%
  arrange(sd_log) %>% 
  View

plot_data_vi2 %>% 
  group_by(Analyte_Code) %>% 
  summarise(mean_diff = mean(Conc_Diff,na.rm = T)) %>% 
  View

mypal <- paletteer_d("ggsci::springfield_simpsons")

vi_plot <- ggplot(plot_data_vi2, aes(x = log_ratio, y = Analyte_Code, color = Category, fill = Category)) +
  # smooth, neutral violins
  geom_violin(
    #fill = "grey90",
    #color = "grey70",
    linewidth = 0.9,
    alpha = 1
  ) +
  geom_boxplot(
    width = 0.4,
    outlier.size = 0.5,
    outlier.alpha = 0.6,
    fatten = 0.7
  ) +
  geom_vline(
    xintercept = 0,
    linetype = "dashed",
    color = "grey40",
    linewidth = 0.5
  ) +
  labs(
    x = "log(Child / Mother)",
    y = NULL,
    title = "Child–Mother Log Ratios Across Exposures"
  ) +
  scale_fill_manual(values = mypal) +
  scale_color_manual(values = mypal) +
  coord_cartesian(clip = "off") +
  #coord_cartesian(xlim = c(-3, 3)) +  # e.g., focus on -3 to +3

  theme_classic(base_size = 16) +
  scale_x_continuous(
  limits = c(-5, 5),
  breaks = c(-5, -3, -1, 0, 1, 3, 5),
  labels = c(
    "148× Mother",
    "20× Mother",
    "2.7× Mother",
    "Equal",
    "2.7× Child",
    "20× Child",
    "148× Child"
  )
) +
  theme(
    plot.title = element_text(
      face = "bold",
      hjust = 0.5,
      size = 14
    ),
    axis.title.x = element_text(
    ),
    axis.text.y = element_text(
      size = 13
    ),
    axis.ticks.y = element_blank(),
    legend.position = "bottom",
    axis.text.x = element_text(angle = -45)

  ) +
  coord_flip()


pdf(file = "../../../Output/Paper1_OutputV2/Plots/Child_Adult_vi.pdf",height = 6,width = 10)
print(vi_plot)
dev.off()
save(vi_plot, file = "../../../Output/Paper1_OutputV2/Plots/vi_plot.RData")


plot_data_vi2 %>% 
  group_by(Analyte_Code) %>% 
  summarise(n = n()) %>% View
```

```{r}
pdf(file = "../../../Output/Paper1_OutputV2/Plots/Child_Adult_Scatter.pdf",height = 6,width = 6)


fit <- lm(log10(Concentration_Child) ~ log10(Concentration_Mat) + Sample_Collection_Year,
          data = plot_data_vi2 %>% dplyr::filter(Study == "DCHS_Targeted"))

summary(fit)
el_data <-  plot_data_vi2 %>% 
  dplyr::filter(Study == "ELEMENT_Targeted") %>% 
  #drop_na() %>% 
  dplyr::filter(Concentration_Mat >0)

fit <- lm(log10(Concentration_Child) ~ log10(Concentration_Mat),
          data = el_data)

summary(fit)

plot_data_scatter <- plot_data_vi2%>% 
  dplyr::filter(Concentration_Mat >0)
mat_child_scatter <- ggplot(plot_data_scatter, 
       aes(x = Concentration_Mat, 
           y = Concentration_Child)) +
  
  # Points (with outline for visibility on log scale)
  geom_point(aes(color = Study), 
             alpha = 0.75, 
             size = 2.4, 
             stroke = 0.2) +
  
  # 1:1 Reference Line
  geom_abline(slope = 1, intercept = 0, 
              linetype = "dashed", 
              linewidth = 0.5, 
              color = "grey40") +
  
  geom_smooth(
    method = "lm",
    formula = y ~ x,
    se = FALSE,
    linewidth = 1.1,
    color = "black"
  ) +

  # Log scales with cleaner breaks
  scale_x_log10(
    labels = scales::label_number(auto = TRUE),
    breaks = scales::log_breaks()
  ) +
  scale_y_log10(
    labels = scales::label_number(auto = TRUE),
    breaks = scales::log_breaks()
  ) +
  
  # Custom palette
  scale_color_manual(values = mypal, name = "Cohort") +
  
  labs(
    title = "Child vs Maternal Exposure",
    subtitle = "Log–log scale with 1:1 reference line",
    x = "Maternal Concentration",
    y = "Child Concentration"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12, colour = "grey30"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
    panel.grid.minor = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(size = 12),
    legend.text  = element_text(size = 10)
  )
print(mat_child_scatter)
dev.off()
save(mat_child_scatter, file = "../../../Output/Paper1_OutputV2/Plots/mat_child_scatter.RData")
```



```{r}
Mat_Conc <- plot_data_vi2 %>% 
  group_by(Analyte_Code) %>% 
  summarise(mean_mat_conc = mean(Concentration_Mat,na.rm = T)) 

Child_Conc <- plot_data_vi2 %>% 
  group_by(Analyte_Code) %>% 
  summarise(mean_child_conc = mean(Concentration_Child,na.rm = T)) 

All_Conc <- left_join(Mat_Conc,Child_Conc,by = "Analyte_Code")  %>%
  pivot_longer(
    cols = c(mean_mat_conc, mean_child_conc),
    names_to = "Group",
    values_to = "Mean_Conc"
  ) %>%
  mutate(
    Group = recode(Group,
                   "mean_mat_conc" = "Maternal",
                   "mean_child_conc" = "Child")
  )

pdf(file = "../../../Output/Paper1_OutputV2/Plots/Child_Adult_Mean_Bar.pdf",height = 6,width = 6)
child_adult_mean_bar <- ggplot(All_Conc,
       aes(y = Analyte_Code, x = abs(log(Mean_Conc)), fill = Group)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  scale_fill_manual(values = c("Maternal" = "steelblue",
                               "Child" = "firebrick")) +
  labs(
    x = "log(Mean Concentration)",
    y = "Exposure",
    fill = NULL,
    title = "Mean Maternal vs Child Concentrations"
  ) +
  theme_classic(base_size = 16) +
  theme(legend.position = "bottom")
print(child_adult_mean_bar)
dev.off()
save(child_adult_mean_bar, file = "../../../Output/Paper1_OutputV2/Plots/child_adult_mean_bar.RData")

```

```{r}
All_Conc %>% 
  View

perc_diff <- All_Conc%>%
  pivot_wider(
    names_from  = Group,
    values_from = Mean_Conc
  ) %>%
  mutate(
    percent_diff = abs(100 * (Maternal - Child) / Child)
  ) 

mean(perc_diff$percent_diff)
```


```{r}
result <- plot_data_vi2 %>%
  mutate(log_ratio = log(Concentration_Child) - log(Concentration_Mat)) %>%
  group_by(Analyte_Code) %>%
  summarise(
    n = n(),
    median_log_ratio = median(log_ratio, na.rm = TRUE),
    fold_change = exp(median_log_ratio),
    p_value = wilcox.test(log_ratio, mu = 0)$p.value
  ) %>%
  mutate(
    p_adj = p.adjust(p_value, method = "fdr")
  ) %>% 
  mutate(Sig_10 = ifelse(p_adj <=0.05,1,0))
```

```{r}
highlight_tbl <- plot_data_vi %>%
  group_by(Analyte_Code) %>%
  summarise(
    median_lr = median(log_ratio, na.rm = TRUE)
  ) %>%
  mutate(
    highlight = ifelse(abs(median_lr) > 0.05, "Highlight", "Normal")
  )

```

```{r}
pdf(file = "../../../Output/Paper1_OutputV2/Plots/Child_Adult_Patch.pdf",height = 15,width = 14)
patch <- (child_adult_mean_bar + mat_child_scatter)/ vi_plot 
patch <- patch + plot_annotation(tag_levels = "A")
print(patch)
dev.off()
```

